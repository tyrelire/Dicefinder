{% extends 'base.html.twig' %}

{% block title %}Modifier Profil{% endblock %}

{% block body %}
<div class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-gray-800 border-2 border-[#363672] p-6 rounded-lg shadow-lg w-full hover:shadow-2xl">
            <h2 class="text-3xl font-bold text-center mb-6 text-white transition-colors duration-300 hover:text-indigo-700">Modification du Compte</h2>
            {{ form_start(form) }}
            <h3 class="text-2xl font-semibold text-indigo-500 mb-4 transition-colors duration-300 hover:text-indigo-600">Informations personnelles</h3>
            <div class="space-y-6">
                <div class="mb-6">
                    {{ form_label(form.username, 'Nom d\'utilisateur', {'label_attr': {'class': 'block text-white font-medium mb-2'}}) }}
                    {{ form_widget(form.username, {
                        'attr': {
                            'class': 'bg-gray-200 text-gray-500 text-base rounded-lg w-full p-3 cursor-not-allowed transition-all duration-300 hover:border-indigo-400',
                            'readonly': true
                        }
                    }) }}
                    {{ form_errors(form.username) }}
                </div>

                <div class="mb-6">
                    {{ form_label(form.firstName, 'Prénom', {'label_attr': {'class': 'block text-white font-medium mb-2'}}) }}
                    {{ form_widget(form.firstName, {'attr': {'class': 'bg-gray-100 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full p-3 transition-all duration-300 hover:border-indigo-400'}}) }}
                    {{ form_errors(form.firstName) }}
                </div>

                <div class="mb-6">
                    {{ form_label(form.lastName, 'Nom', {'label_attr': {'class': 'block text-white font-medium mb-2'}}) }}
                    {{ form_widget(form.lastName, {'attr': {'class': 'bg-gray-100 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full p-3 transition-all duration-300 hover:border-indigo-400'}}) }}
                    {{ form_errors(form.lastName) }}
                </div>

                <div class="mb-6">
                    {{ form_label(form.email, 'Adresse email', {'label_attr': {'class': 'block text-white font-medium mb-2'}}) }}
                    <div class="relative mt-1 rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path d="M3 4a2 2 0 00-2 2v1.161l8.441 4.221a1.25 1.25 0 001.118 0L19 7.162V6a2 2 0 00-2-2H3z" />
                                <path d="M19 8.839l-7.77 3.885a2.75 2.75 0 01-2.46 0L1 8.839V14a2 2 0 002 2h14a2 2 0 002-2V8.839z" />
                            </svg>
                        </div>
                        {{ form_widget(form.email, {
                            'attr': {
                                'class': 'bg-gray-100 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full pl-10 p-3 transition-all duration-300 hover:border-indigo-400',
                                'placeholder': 'you@example.com'
                            }
                        }) }}
                    </div>
                    {{ form_errors(form.email) }}
                </div>

                <div class="mb-6">
                    {{ form_label(form.phoneNumber, 'Numéro de téléphone', {'label_attr': {'class': 'block text-white font-medium mb-2'}}) }}
                    <div class="relative mt-1 rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 19 18">
                                <path d="M18 13.446a3.02 3.02 0 0 0-.946-1.985l-1.4-1.4a3.054 3.054 0 0 0-4.218 0l-.7.7a.983.983 0 0 1-1.39 0l-2.1-2.1a.983.983 0 0 1 0-1.389l.7-.7a2.98 2.98 0 0 0 0-4.217l-1.4-1.4a2.824 2.824 0 0 0-4.218 0c-3.619 3.619-3 8.229 1.752 12.979C6.785 16.639 9.45 18 11.912 18a7.175 7.175 0 0 0 5.139-2.325A2.9 2.9 0 0 0 18 13.446Z"/>
                            </svg>
                        </div>
                        {{ form_widget(form.phoneNumber, {
                            'attr': {
                                'id': 'phoneNumber',
                                'class': 'bg-gray-100 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full pl-10 p-3 transition-all duration-300 hover:border-indigo-400',
                                'placeholder': '06 12 34 56 78',
                                'oninput': 'formatPhoneNumber(this)',
                                'maxlength': '14'
                            }
                        }) }}
                    </div>
                    {{ form_errors(form.phoneNumber) }}
                </div>

                <div class="mb-6">
                    {{ form_label(form.birthDate, 'Date de naissance', {'label_attr': {'class': 'block text-white font-medium mb-2'}}) }}
                    {{ form_widget(form.birthDate, {'attr': {'class': 'bg-gray-100 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full p-3 transition-all duration-300 hover:border-indigo-400'}}) }}
                    {{ form_errors(form.birthDate) }}
                </div>

                <div class="mb-6">
                    {{ form_label(form.gender, 'Genre', {'label_attr': {'class': 'block text-white font-medium mb-2'}}) }}
                    {{ form_widget(form.gender, {
                        'attr': {'class': 'flex items-center space-x-4 text-white font-medium'}
                        })
                    }}
                    {{ form_errors(form.birthDate) }}

                </div>
            </div>

            <div class="flex justify-end mt-8">
                <button type="submit" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-transform duration-300 transform hover:-translate-y-1 hover:shadow-lg">
                    Mettre à jour
                </button>
            </div>
            {{ form_end(form) }}
        </div>
        
        <div class="bg-gray-800 border-2 border-[#363672] p-6 rounded-lg shadow-lg w-full hover:shadow-2xl">
            <h2 class="text-3xl font-bold text-center mb-6 text-white transition-colors duration-300 hover:text-indigo-700">Modification du Profil</h2>
            {{ form_start(socialMediaAndCompetenceForm) }}
            <h3 class="text-2xl font-semibold text-indigo-500 mb-4 transition-colors duration-300 hover:text-indigo-600">Réseaux Sociaux</h3>
            <div class="space-y-6">
                <div class="mb-6">
                    {{ form_label(socialMediaAndCompetenceForm.discordPseudo, 'Pseudo Discord', {'label_attr': {'class': 'block text-white font-medium mb-2'}}) }}
                    {{ form_widget(socialMediaAndCompetenceForm.discordPseudo, {'attr': {'class': 'bg-gray-100 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full p-3 transition-all duration-300 hover:border-indigo-400', 'oninput': 'validateDiscordPseudo(this)' }}) }}
                    {{ form_errors(socialMediaAndCompetenceForm.discordPseudo) }}
                </div>

                <div class="mb-6">
                    {{ form_label(socialMediaAndCompetenceForm.TwitterPseudo, 'Pseudo Twitter', {'label_attr': {'class': 'block text-white font-medium mb-2'}}) }}
                    {{ form_widget(socialMediaAndCompetenceForm.TwitterPseudo, {'attr': {'class': 'bg-gray-100 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full p-3 transition-all duration-300 hover:border-indigo-400', 'oninput': 'validateTwitterPseudo(this)' }}) }}
                    {{ form_errors(socialMediaAndCompetenceForm.TwitterPseudo) }}
                </div>

                <div class="mb-6">
                    {{ form_label(socialMediaAndCompetenceForm.YoutubeChannelLink, 'Lien de chaîne YouTube', {'label_attr': {'class': 'block text-white font-medium mb-2'}}) }}
                    {{ form_widget(socialMediaAndCompetenceForm.YoutubeChannelLink, {'attr': {'class': 'bg-gray-100 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full p-3 transition-all duration-300 hover:border-indigo-400', 'oninput': 'validateYouTubeLink(this)' }}) }}
                    {{ form_errors(socialMediaAndCompetenceForm.YoutubeChannelLink) }}
                </div>

                <div class="mb-6">
                    {{ form_label(socialMediaAndCompetenceForm.TwitchChannelLink, 'Lien de chaîne Twitch', {'label_attr': {'class': 'block text-white font-medium mb-2'}}) }}
                    {{ form_widget(socialMediaAndCompetenceForm.TwitchChannelLink, {'attr': {'class': 'bg-gray-100 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full p-3 transition-all duration-300 hover:border-indigo-400', 'oninput': 'validateTwitchLink(this)' }}) }}
                    {{ form_errors(socialMediaAndCompetenceForm.TwitchChannelLink) }}
                </div>
            </div>

            <h3 class="text-2xl font-semibold text-indigo-500 mt-8 mb-4 transition-colors duration-300 hover:text-indigo-600">Compétences</h3>
            <div class="space-y-6">
                <div class="mb-6">
                    {{ form_widget(socialMediaAndCompetenceForm.competence, {'attr': {'class': 'bg-gray-100 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full p-3 transition-all duration-300 hover:border-indigo-400', 'rows': '4', 'placeholder': 'Écrivez la description ici...', 'maxlength': '255', 'oninput': 'updateCharCountComp(this)' }}) }}
                    <div id="charCountComp" class="text-gray-400 text-sm mt-1"></div>
                    {{ form_errors(socialMediaAndCompetenceForm.competence) }}
                </div>
            </div>

            <h3 class="text-2xl font-semibold text-indigo-500 mt-8 mb-4 transition-colors duration-300 hover:text-indigo-600">Biographie</h3>
            <div class="space-y-6">
                <div class="mb-6">
                    {{ form_widget(socialMediaAndCompetenceForm.bio, {'attr': {'class': 'bg-gray-100 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full p-3 transition-all duration-300 hover:border-indigo-400', 'rows': '4', 'placeholder': 'Écrivez la description ici...', 'maxlength': '255', 'oninput': 'updateCharCountBio(this)' }}) }}
                    <div id="charCountBio" class="text-gray-400 text-sm mt-1"></div>
                    {{ form_errors(socialMediaAndCompetenceForm.bio) }}
                </div>
            </div>
            <div class="flex justify-end mt-8">
                <button type="submit" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-transform duration-300 transform hover:-translate-y-1 hover:shadow-lg">
                    Mettre à jour
                </button>
            </div>
            {{ form_end(socialMediaAndCompetenceForm) }}
        </div>

        <div class="bg-gray-800 border-2 border-[#363672] p-6 rounded-lg shadow-lg w-full">
            <h2 class="text-3xl font-bold text-center mb-6 text-white transition-colors duration-300 hover:text-indigo-700">Changer le mot de passe</h2>
            {{ form_start(passwordForm) }}
            <div class="space-y-4">
                <div class="mb-4">
                    {{ form_label(passwordForm.current_password, 'Mot de passe actuel', {'label_attr': {'class': 'block text-white mb-1'}}) }}
                    {{ form_widget(passwordForm.current_password, {'attr': {'class': 'bg-gray-100 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full p-3 transition-all duration-300 hover:border-indigo-400'}}) }}
                    {{ form_errors(passwordForm.current_password) }}
                </div>

                <div class="mb-4">
                    {{ form_label(passwordForm.new_password, 'Nouveau mot de passe', {'label_attr': {'class': 'block text-white mb-1'}}) }}
                    {{ form_widget(passwordForm.new_password, {'attr': {'class': 'bg-gray-100 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full p-3 transition-all duration-300 hover:border-indigo-400'}}) }}
                    {{ form_errors(passwordForm.new_password) }}
                </div>

                <div class="mb-4">
                    {{ form_label(passwordForm.confirm_password, 'Confirmer le nouveau mot de passe', {'label_attr': {'class': 'block text-white mb-1'}}) }}
                    {{ form_widget(passwordForm.confirm_password, {'attr': {'class': 'bg-gray-100 border border-gray-300 text-gray-900 text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full p-3 transition-all duration-300 hover:border-indigo-400'}}) }}
                    {{ form_errors(passwordForm.confirm_password) }}
                </div>
            </div>

            <div class="flex justify-end mt-6">
                <button type="submit" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-transform duration-300 transform hover:-translate-y-1 hover:shadow-lg">
                    Mettre à jour le mot de passe
                </button>
            </div>
            {{ form_end(passwordForm) }}
        </div>

        <div class="bg-gray-800 border-2 border-[#363672] p-6 rounded-lg shadow-lg w-full">
            <h2 class="text-3xl font-bold text-center mb-6 text-white transition-colors duration-300 hover:text-indigo-700">Modifier l'avatar</h2>
            {{ form_start(avatarForm, {'attr': {'enctype': 'multipart/form-data'}}) }}
            <div class="flex items-center justify-center mb-6">
                <div class="flex flex-col items-center mr-6 pt-10">
                    <img id="avatarPreview" class="w-40 h-40 rounded-full ring-4 ring-indigo-300 object-cover transition-transform duration-300 hover:scale-110"
                        src="{{ app.user.avatar ? asset('uploads/avatars/' ~ app.user.avatar) : asset('images/default-avatar.png') }}"
                        alt="Photo de profil">
                    {% if app.user.avatar %}
                        <button type="submit" name="delete_avatar" value="1" class="text-red-600 text-xs mt-2 underline hover:text-red-800">
                            Supprimer la photo
                        </button>
                    {% endif %}
                </div>
                <div class="ml-6">
                    {{ form_widget(avatarForm.avatar, {'attr': {'class': 'hidden', 'onchange': 'previewAvatar(this)'}}) }}
                    {{ form_errors(avatarForm.avatar) }}
                    <label for="{{ avatarForm.avatar.vars.id }}" class="cursor-pointer bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 inline-flex items-center transition-transform duration-300 transform hover:-translate-y-1">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
                        </svg>
                        Choisir une photo
                    </label>
                    <p class="text-xs text-gray-500 mt-2">JPG, GIF ou PNG. 1MB max.</p>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button type="submit" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-transform duration-300 transform hover:-translate-y-1 hover:shadow-lg">
                    Mettre à jour l'avatar
                </button>
            </div>
            {{ form_end(avatarForm) }}
        </div>
    </div>
</div>

<script>
    function updateCharCountComp(textarea) {
        const maxChars = 255;
        const remainingChars = maxChars - textarea.value.length;
        document.getElementById('charCountComp').textContent = remainingChars + " caractères restants";
    }

    function updateCharCountBio(textarea) {
        const maxChars = 255;
        const remainingChars = maxChars - textarea.value.length;
        document.getElementById('charCountBio').textContent = remainingChars + " caractères restants";
    }

    function validateDiscordPseudo(input) {
        if (input.value !== "") {
            const regex = /^[a-zA-Z0-9._-]{3,32}$/;
            if (!regex.test(input.value)) {
                input.setCustomValidity('Veuillez entrer un pseudo Discord valide (3 à 32 caractères, lettres, chiffres, "." , "-" et "_" sont autorisés)');
            } else {
                input.setCustomValidity('');
            }
        } else {
            input.setCustomValidity('');
        }
    }

    function validateTwitterPseudo(input) {
        if (input.value.trim() !== "") {
            const regex = /^@?(\w){1,15}$/;
            if (!regex.test(input.value.trim())) {
                input.setCustomValidity('Veuillez entrer un pseudo Twitter valide, exemple: @username');
            } else {
                input.setCustomValidity('');
            }
        } else {
            input.setCustomValidity('');
        }
    }

    function validateYouTubeLink(input) {
        if (input.value !== "") {
            const regex = /^(https?\:\/\/)?(www\.)?(youtube\.com|youtu\.?be)\/.+$/;
            if (!regex.test(input.value)) {
                input.setCustomValidity('Veuillez entrer un lien YouTube valide');
            } else {
                input.setCustomValidity('');
            }
        } else {
            input.setCustomValidity('');
        }
    }

    function validateTwitchLink(input) {
        if (input.value !== "") {
            const regex = /^(https?:\/\/)?(www\.)?twitch\.tv\/[a-zA-Z0-9_]+$/;
            if (!regex.test(input.value)) {
                input.setCustomValidity('Veuillez entrer un lien Twitch valide');
            } else {
                input.setCustomValidity('');
            }
        } else {
            input.setCustomValidity('');
        }
}

    function previewAvatar(input) {
        var preview = document.getElementById('avatarPreview');
        var file = input.files[0];
        var reader = new FileReader();

        reader.onloadend = function() {
            preview.src = reader.result;
        };

        if (file) {
            reader.readAsDataURL(file);
        } else {
            preview.src = "{{ asset('images/default-avatar.png') }}";
        }
    }

    function formatPhoneNumber(input) {
        let phone = input.value.replace(/\D/g, '');

        if (phone.length > 2) {
            phone = phone.replace(/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})$/, '$1 $2 $3 $4 $5');
        } else if (phone.length > 4) {
            phone = phone.replace(/(\d{2})(\d{2})(\d{2})(\d{2})$/, '$1 $2 $3 $4');
        } else if (phone.length > 6) {
            phone = phone.replace(/(\d{2})(\d{2})(\d{2})$/, '$1 $2 $3');
        } else if (phone.length > 8) {
            phone = phone.replace(/(\d{2})(\d{2})$/, '$1 $2');
        }

        input.value = phone;
    }

    document.addEventListener("DOMContentLoaded", function() {
        const competenceField = document.querySelector('[name="socialMediaAndCompetenceForm[competence]"]');
        const bioField = document.querySelector('[name="socialMediaAndCompetenceForm[bio]"]');

        if (competenceField) {
            updateCharCountComp(competenceField);
            competenceField.addEventListener('input', function() {
                updateCharCountComp(competenceField);
            });
        }

        if (bioField) {
            updateCharCountBio(bioField);
            bioField.addEventListener('input', function() {
                updateCharCountBio(bioField);
            });
        }
    });
</script>
{% endblock %}
